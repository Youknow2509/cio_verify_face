version: '3.8'

services:
    # Auth Service
    auth-service:
        build: .
        ports:
            - '8080:8080' # HTTP API
            - '50051:50051' # gRPC
        environment:
            - CONFIG_PATH=/app/config/config.yaml
        volumes:
            - ./config:/app/config:ro
            - ./logs:/app/logs
        depends_on:
            - postgres
            - redis
            - kafka
        networks:
            - auth-network
        restart: unless-stopped
        healthcheck:
            test: ['CMD', 'nc', '-z', 'localhost', '8080']
            interval: 30s
            timeout: 10s
            retries: 3

    # PostgreSQL Database
    postgres:
        image: postgres:15-alpine
        environment:
            POSTGRES_DB: auth_service
            POSTGRES_USER: auth_user
            POSTGRES_PASSWORD: auth_password
        ports:
            - '5432:5432'
        volumes:
            - postgres_data:/var/lib/postgresql/data
            - ./init.sql:/docker-entrypoint-initdb.d/init.sql:ro
        networks:
            - auth-network
        restart: unless-stopped

    # Redis Cache
    redis:
        image: redis:7-alpine
        ports:
            - '6379:6379'
        volumes:
            - redis_data:/data
        networks:
            - auth-network
        restart: unless-stopped
        command: redis-server --appendonly yes

    # Apache Kafka
    kafka:
        image: confluentinc/cp-kafka:latest
        ports:
            - '9092:9092'
        environment:
            KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
            KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
            KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
            KAFKA_AUTO_CREATE_TOPICS_ENABLE: true
        volumes:
            - kafka_data:/var/lib/kafka/data
        depends_on:
            - zookeeper
        networks:
            - auth-network
        restart: unless-stopped

    # Zookeeper for Kafka
    zookeeper:
        image: confluentinc/cp-zookeeper:latest
        ports:
            - '2181:2181'
        environment:
            ZOOKEEPER_CLIENT_PORT: 2181
            ZOOKEEPER_TICK_TIME: 2000
        volumes:
            - zookeeper_data:/var/lib/zookeeper/data
        networks:
            - auth-network
        restart: unless-stopped

    # MinIO Object Storage
    minio:
        image: minio/minio:latest
        ports:
            - '9000:9000'
            - '9001:9001'
        environment:
            MINIO_ROOT_USER: minioadmin
            MINIO_ROOT_PASSWORD: minioadmin
        volumes:
            - minio_data:/data
        command: server /data --console-address ":9001"
        networks:
            - auth-network
        restart: unless-stopped

    # ScyllaDB (Optional - if using ScyllaDB)
    scylladb:
        image: scylladb/scylla:latest
        ports:
            - '9042:9042'
        volumes:
            - scylla_data:/var/lib/scylla
        networks:
            - auth-network
        restart: unless-stopped
        profiles:
            - scylla

    # gRPC Client Example (for testing)
    grpc-client:
        build: .
        command: go run examples/grpc_client_example.go
        depends_on:
            - auth-service
        networks:
            - auth-network
        profiles:
            - testing

volumes:
    postgres_data:
    redis_data:
    kafka_data:
    zookeeper_data:
    minio_data:
    scylla_data:

networks:
    auth-network:
        driver: bridge
