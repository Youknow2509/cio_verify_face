sequenceDiagram
    autonumber
    participant Admin as Company Admin
    participant Gateway as API Gateway
    box "Core Services" #f9f9f9
        participant Identity as Identity Service
        participant AI as AI Engine
    end
    box "Data Persistence" #ececec
        participant Data as Data Layer (DB/Storage)
        participant Queue as Event Queue
    end

    Admin->>+Gateway: POST /users/{id}/face-data (Images)
    Gateway->>Gateway: Validate Admin Token & Permissions
    Gateway->>+Identity: Forward Request
    
    Note right of Identity: Start Enrollment Process

    loop For each Image
        Identity->>+AI: Analyze & Vectorize
        Note right of AI: 1. Face Detection<br/>2. Quality Check (Blur/Angle)<br/>3. Generate Embeddings (512-d)
        
        alt Quality Check Failed
            AI-->>Identity: Error: Low Quality
        else Quality Check Passed
            AI-->>-Identity: Return Vector Embeddings
            Identity->>+Data: Store Encrypted Image & Vector
            Data-->>-Identity: Stored Successfully
        end
    end

    Identity->>+Data: Update User Profile (Face Registered = True)
    Data-->>-Identity: Confirm Update

    par Async Processing
        Identity->>Queue: Publish "FaceUpdated" Event
        Note right of Queue: Triggers Model Retraining<br/>& Sync to Edge Devices
    and Response
        Identity-->>-Gateway: 201 Created
        Gateway-->>-Admin: Enrollment Success
    end