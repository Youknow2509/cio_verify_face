sequenceDiagram
    autonumber
    participant User as User/Device
    participant Gateway as API Gateway
    box Authentication #fffbf0
        participant Auth as Auth Service
        participant Identity as Identity Service
    end
    participant Data as Data Layer

    User->>+Gateway: POST /login (Username, Password, Company ID)
    Gateway->>Gateway: Rate Limiting Check
    Note right of Gateway: Max 5 attempts / 15 min per IP
    
    Gateway->>+Auth: Validate Login Request
    
    Auth->>+Identity: Verify Credentials
    Note right of Identity: Multi-tenant lookup<br/>Password hash comparison
    
    alt Invalid Credentials
        Identity-->>Auth: Error: Invalid
        Auth->>Auth: Increment Failed Attempts
        Auth-->>Gateway: 401 Unauthorized
        Gateway-->>User: Login Failed
    else Valid Credentials
        Identity->>+Data: Fetch User Profile & Permissions
        Data-->>-Identity: User Data
        Identity-->>-Auth: Authentication Success
        
        Auth->>Auth: Generate JWT Tokens
        Note right of Auth: • Access Token (15 min)<br/>• Refresh Token (7 days)
        
        par Finalize Session
            Auth->>Data: Store Refresh Token (7d TTL)
        and Response
            Auth-->>-Gateway: 200 OK + Tokens
            Gateway-->>-User: Login Success
        end
    end