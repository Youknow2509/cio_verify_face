sequenceDiagram
    participant Device as Device Client
    participant LB as Load Balancer
    participant Gateway as API Gateway
    participant Auth as Auth Service
    participant DeviceMgmt as Device Management
    participant Cache as Redis Cache
    participant DB as PostgreSQL
    participant Audit as Audit Service

    Device->>+LB: POST /api/v1/auth/device/activate
    Note over Device,LB: {device_serial, activation_code, company_id}
    
    LB->>+Gateway: Forward request
    Gateway->>Gateway: Validate request format
    Gateway->>Gateway: Rate limiting per device_serial
    
    Gateway->>+Auth: POST /api/v1/auth/device/activate
    
    Auth->>+Cache: Check activation attempts
    Note over Auth,Cache: Key: device_activation:{device_serial}
    Cache-->>-Auth: Attempt count
    
    alt Too many attempts
        Auth-->>Gateway: 429 Too Many Requests
        Gateway-->>LB: Rate limited
        LB-->>Device: Activation rate limited
    else Valid attempt count
        Auth->>+DeviceMgmt: Validate activation code
        Note over Auth,DeviceMgmt: Check device registration status
        
        DeviceMgmt->>+Cache: GET device_info:{device_serial}
        Cache-->>-DeviceMgmt: Device data or cache miss
        
        alt Cache miss
            DeviceMgmt->>+DB: SELECT * FROM devices WHERE serial AND company_id
            Note over DeviceMgmt,DB: Partitioned by company_id
            DB-->>-DeviceMgmt: Device record
            DeviceMgmt->>Cache: Cache device info (TTL: 1hour)
        end
        
        DeviceMgmt->>DeviceMgmt: Validate activation code
        Note over DeviceMgmt: Check code expiration, company match
        
        alt Invalid activation code
            DeviceMgmt-->>Auth: Invalid code
            Auth->>Cache: Increment activation attempts
            Auth-->>Gateway: 400 Bad Request - Invalid code
        else Valid activation code
            DeviceMgmt->>+DB: UPDATE devices SET status='active', activated_at=NOW()
            Note over DeviceMgmt,DB: Mark device as activated
            DB-->>-DeviceMgmt: Device activated
            
            DeviceMgmt->>Cache: Update device cache
            DeviceMgmt-->>-Auth: Device activation successful
            
            Auth->>Auth: Generate device credentials
            Note over Auth: Device-specific JWT with longer TTL (30 days)
            
            par Store device session
                Auth->>+Cache: Store device session
                Note over Auth,Cache: Key: device_session:{device_id}<br/>TTL: 30 days
                Cache-->>-Auth: Session stored
            and Log activation event
                Auth->>+Audit: Log device activation
                Note over Auth,Audit: Async audit logging
                Audit-->>-Auth: Event logged
            end
            
            Auth->>Cache: Reset activation attempts
            Auth-->>-Gateway: 200 OK with device credentials
        end
    end
    
    Gateway-->>-LB: Response
    LB-->>-Device: Activation response
    