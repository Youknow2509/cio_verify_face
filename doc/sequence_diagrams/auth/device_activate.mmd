sequenceDiagram
    autonumber
    participant Device as Device Client
    participant Gateway as API Gateway
    box Security Core #fff5f5
        participant Auth as Auth Service
        participant Registry as Device Registry
    end
    participant Audit as Audit Log

    Device->>+Gateway: POST /activate (Serial, Code, Company ID)
    Gateway->>Gateway: Rate Limiting Check
    Note right of Gateway: Prevent brute-force attacks<br/>Max 5 attempts / 5 min
    
    Gateway->>+Auth: Validate Activation Request

    Auth->>+Registry: Verify Serial & Activation Code
    Note right of Registry: Check device pre-registration<br/>Validate code expiration<br/>Verify company ownership
    
    alt Invalid or Expired Code
        Registry-->>Auth: Error: Invalid/Expired
        Auth->>Auth: Increment Failed Attempts
        Auth-->>Gateway: 400 Bad Request
        Gateway-->>Device: Activation Failed
    else Valid Activation Code
        Registry->>Registry: Update Status = ACTIVE
        Registry-->>-Auth: Activation Confirmed
        
        Auth->>Auth: Generate Device JWT
        Note right of Auth: Long-lived token (30 days)<br/>Device-specific credentials
        
        par Finalize Activation
            Auth->>Audit: Log "Device Activated" Event
            Note right of Audit: Async audit trail
        and Store Session
            Auth->>Auth: Cache Device Session (30d TTL)
        end
        
        Auth-->>-Gateway: 200 OK + Credentials
        Gateway-->>-Device: Activation Success
    end